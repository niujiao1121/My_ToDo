name: Auto Link Subtasks

on:
  issues:
    types: [opened]

jobs:
  update-parent-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Auto add issue to parent project's subtask list
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            // åŒ¹é…â€œåŸå§‹è¾“å…¥æ¥è‡ª: #æ•°å­—â€æˆ–â€œå±äº#æ•°å­—â€æˆ–â€œé¡¹ç›®#æ•°å­—â€
            const parentMatch = issueBody.match(/åŸå§‹è¾“å…¥æ¥è‡ª[:ï¼š]?\s*#(\d+)|å±äº#?(\d+)/i);
            const parentNumber = parentMatch ? (parentMatch[1] || parentMatch[2]) : null;
            if (!parentNumber) {
              console.log("No parent issue referenced in body, skipping.");
              return;
            }
            // è·å–çˆ¶issuebody
            const parent = await github.rest.issues.get({
              owner, repo, issue_number: parentNumber,
            });
            let body = parent.data.body;
            const lines = body.split('\n');
            // æ‰¾åˆ°â€œ## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨â€ï¼Œæ’å…¥
            let found = false;
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].includes("## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨")) {
                let insertIdx = i+1;
                // è·³è¿‡æ³¨é‡Šè¡Œ
                while (insertIdx < lines.length && lines[insertIdx].trim().startsWith('<')) insertIdx++;
                // é˜²æ­¢é‡å¤
                if (!body.includes(`#${issueNumber}`)) {
                  lines.splice(insertIdx, 0, `- [ ] #${issueNumber} - ${issueTitle}`);
                }
                found = true;
                break;
              }
            }
            if (!found) {
              lines.push("\n## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨");
              lines.push(`- [ ] #${issueNumber} - ${issueTitle}`);
            }
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: parentNumber,
              body: lines.join('\n'),
            });
