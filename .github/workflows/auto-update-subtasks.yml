name: Auto Link Subtasks

on:
  issues:
    types: [opened]

jobs:
  update-parent-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Auto add issue to parent project's subtask list
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;
            const issueLabels = context.payload.issue.labels.map(l => l.name);
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // Skip if issue has ai-generated label (already handled by ai-create-todo workflow)
            if (issueLabels.includes('ai-generated')) {
              console.log("Issue has ai-generated label, skipping (handled by ai-create-todo workflow).");
              return;
            }
            
            // åŒ¹é…"åŸå§‹è¾“å…¥æ¥è‡ª: #æ•°å­—"æˆ–"å±äº#æ•°å­—"æˆ–"é¡¹ç›®#æ•°å­—"
            const parentMatch = issueBody.match(/åŸå§‹è¾“å…¥æ¥è‡ª[:ï¼š]?\s*#(\d+)|å±äº#?(\d+)/i);
            const parentNumber = parentMatch ? (parentMatch[1] || parentMatch[2]) : null;
            if (!parentNumber) {
              console.log("No parent issue referenced in body, skipping.");
              return;
            }
            
            // è·å–çˆ¶issuebody
            const parent = await github.rest.issues.get({
              owner, repo, issue_number: parentNumber,
            });
            let body = parent.data.body;
            
            // é˜²æ­¢é‡å¤ - æ£€æŸ¥çˆ¶ä»»åŠ¡bodyä¸­æ˜¯å¦å·²åŒ…å«æ­¤issueç¼–å·
            if (body.includes(`#${issueNumber}`)) {
              console.log(`Issue #${issueNumber} already exists in parent issue #${parentNumber}, skipping to avoid duplication.`);
              return;
            }
            
            const lines = body.split('\n');
            // æ‰¾åˆ°"## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨"ï¼Œæ’å…¥
            let found = false;
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].includes("## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨")) {
                let insertIdx = i+1;
                // è·³è¿‡æ³¨é‡Šè¡Œ
                while (insertIdx < lines.length && lines[insertIdx].trim().startsWith('<')) insertIdx++;
                // æ·»åŠ å­ä»»åŠ¡é¡¹
                lines.splice(insertIdx, 0, `- [ ] #${issueNumber} - ${issueTitle}`);
                found = true;
                break;
              }
            }
            if (!found) {
              lines.push("\n## ğŸ“ å­ä»»åŠ¡åˆ—è¡¨");
              lines.push(`- [ ] #${issueNumber} - ${issueTitle}`);
            }
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: parentNumber,
              body: lines.join('\n'),
            });
